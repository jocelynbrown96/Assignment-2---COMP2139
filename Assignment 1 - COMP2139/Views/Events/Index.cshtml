@model IEnumerable<Assignment_1___COMP2139.Models.Event>
@using Assignment_1___COMP2139.Models
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Events";
    var categories = ViewBag.Categories as List<Category>;
    var selectedCategory = ViewBag.SelectedCategory as int?;
    var sortOrder = Context.Request.Query["sortOrder"].ToString();
}

<style>
    .navbar.bg-white { background-color: black !important; }
    .bg-white { background-color: #222 !important; }
    .navbar .nav-link { color: white !important; text-align: right; }
    .navbar .nav-link.active,
    .navbar .nav-link:hover { color: #ffa500 !important; }
    body { background-color: lightgrey; margin: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    .navbar-light .navbar-brand { color: #fff !important; }
    .banner-container { position: relative; width: 100vw; left: 50%; margin-left: -50vw; }
    .banner-title {
        position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
        color: #fff; font-size: 6rem; font-weight: bold; text-shadow: 0 2px 14px #1A1A1A;
        width: 100%; text-align: center;
    }
    .banner-search {
        position: absolute; top: 80%; left: 50%; transform: translate(-50%, -50%);
        display: flex; gap: 12px; width: 440px; justify-content: center;
    }
    .banner-search input {
        padding: 12px 20px; font-size: 1.1rem; border-radius: 10px;
        border: 1px solid #aaa; width: 320px;
    }
    .banner-search button {
        padding: 12px 24px; border-radius: 10px; border: none;
        background: #222; color: #fff; font-size: 1.1rem; font-weight: bold;
    }
    .banner-search button:hover { background: #444; }
    .filter-create-container {
        width: 100%; display: flex; justify-content: center; align-items: center;
        gap: 24px; background: rgba(255,255,255,0.94); border-radius: 18px;
        padding: 22px 30px; margin-bottom: 32px;
    }
    .btn-create {
        padding: 15px 30px; border-radius: 14px; font-size: 1.12rem; font-weight: 600;
        background: #222; color: #fff !important; border: none;
    }
    .btn-create:hover { background: #ffa500; color: #222 !important; }
    table.table {
        border: 2px solid #00aeff; width: 100%; border-collapse: separate;
        border-spacing: 0; background: #d3d3d3; border-radius: 10px;
        overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }
    table.table thead tr { background: #222; color: #ffa500; font-weight: bold; }
    table.table th, table.table td {
        padding: 12px 20px; text-align: left; border-bottom: 1px solid #bbb;
    }
    table.table tbody tr:hover { background: #00aeff; color: white; cursor: pointer; }
    .btn { padding: 12px 32px; font-size: 1.08rem; font-weight: bold;
          border-radius: 20px; height: 52px; border: none; }
    .btn-buy    { background: green; color: #fff; }
    .btn-edit   { background: #ffa500; color: #fff; }
    .btn-delete { background: #dc3545; color: #fff; }
</style>

<!-- Banner -->
<div class="banner-container">
    <img src="/HomeBanner.png" style="width: 100vw; height: 320px; object-fit: cover; display: block;">
    <h1 class="banner-title">Events</h1>
    <form asp-controller="Events" asp-action="Index" method="get" class="banner-search">
        <input type="text" name="searchString" value="@Context.Request.Query["searchString"]" placeholder="Search events..." />
        <button type="submit">Search</button>
    </form>
</div>

<!-- Filters + Create button -->
<div class="filter-create-container">
    <form method="get" asp-action="Index" style="display:flex;align-items:center;gap:20px;margin:0;">
        <label>Category:</label>
        <select id="categoryFilter" name="categoryId" class="form-select" onchange="this.form.submit()">
            <option value="">All</option>
            @foreach (var category in categories)
            {
                <option value="@category.Id" selected="@(selectedCategory == category.Id)">
                    @category.Name
                </option>
            }
        </select>

        <label>Price:</label>
        <select id="priceSort" name="sortOrder" class="form-select" onchange="this.form.submit()">
            <option value="">Default</option>
            <option value="priceAsc" selected="@(sortOrder == "priceAsc")">Low → High</option>
            <option value="priceDesc" selected="@(sortOrder == "priceDesc")">High → Low</option>
        </select>
    </form>

    <!-- CREATE BUTTON (Only Admin + Organizer) -->
    @if (User.IsInRole("Admin") || User.IsInRole("Organizer"))
    {
        <a asp-action="Create" class="btn-create">+ Add New Event</a>
    }
</div>

<!-- Events Table -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>Title</th>
            <th>Date</th>
            <th>Location</th>
            <th>Category</th>
            <th>Price</th>
            <th>Tickets</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>

@foreach (var ev in Model)
{
    var currentUserId = UserManager.GetUserId(User);
    bool isOwner = (ev.OrganizerId == currentUserId);
    bool isAdmin = User.IsInRole("Admin");
    bool isOrganizer = User.IsInRole("Organizer");

    <tr>
        <td>
            <a asp-controller="Events" asp-action="Details" asp-route-id="@ev.Id">@ev.Title</a>
        </td>

        <td>@ev.Date.ToString("MMMM dd, yyyy")</td>
        <td>@ev.Location</td>
        <td>@ev.Category?.Name</td>
        <td>$@ev.TicketPrice.ToString("F2")</td>

        <td>
            @ev.AvailableTickets
            @if (ev.AvailableTickets < 5)
            {
                <span style="color:red;font-weight:bold;margin-left:6px;">⚠ Low stock!</span>
            }
        </td>

        <td class="action-buttons">

            <!-- ALWAYS visible: BUY -->
            <form asp-controller="Purchases" asp-action="Create" method="get" style="display:inline;">
                <input type="hidden" name="eventId" value="@ev.Id" />
                <button type="submit" class="btn btn-buy">
                    <i class="fas fa-shopping-cart"></i> Buy
                </button>
            </form>

            <!-- ADMIN sees Edit/Delete on ALL events -->
            @if (isAdmin)
            {
                <a asp-action="Edit" asp-route-id="@ev.Id" class="btn btn-edit">
                    <i class="fas fa-edit"></i> Edit
                </a>

                <form asp-action="Delete" asp-route-id="@ev.Id" method="post" style="display:inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-delete">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </form>
            }

            <!-- ORGANIZER sees Edit/Delete ONLY on THEIR OWN events -->
            @if (isOrganizer && isOwner)
            {
                <a asp-action="Edit" asp-route-id="@ev.Id" class="btn btn-edit">
                    <i class="fas fa-edit"></i> Edit
                </a>

                <form asp-action="Delete" asp-route-id="@ev.Id" method="post" style="display:inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-delete">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </form>
            }

        </td>
    </tr>
}

    </tbody>
</table>